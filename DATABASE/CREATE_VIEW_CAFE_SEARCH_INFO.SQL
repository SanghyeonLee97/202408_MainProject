
CREATE VIEW CAFE_SEARCH_INFO
AS
WITH A1 AS ( -- 좋아요 CNT
	SELECT *
	FROM (
		SELECT 
			MA.CAFE_ID AS LIKE_CAFE_ID, 
			MAX(MA.MOD_DATE) AS LIKE_MOD_DATE,
			COUNT(MA.GOOD) AS LIKE_CNT
		FROM MEMBER_ACT MA
		JOIN CAFE C ON MA.CAFE_ID = C.CAFE_ID
		WHERE 1=1
		AND MA.GOOD = 'Y'
		GROUP BY MA.CAFE_ID
	) A
),
A2 AS ( -- 리뷰 CNT
	SELECT *
	FROM (        
		SELECT 
			MA.CAFE_ID AS REVIEW_CAFE_ID,
			MAX(MA.MOD_DATE) AS REVIEW_MOD_DATE,
			COUNT(MA.REVIEW) AS REVIEW_CNT
		FROM MEMBER_ACT MA
		JOIN CAFE C ON MA.CAFE_ID = C.CAFE_ID
		WHERE 1=1
		AND MA.REVIEW IS NOT NULL
		GROUP BY MA.CAFE_ID
	) A
),
A3 AS ( -- 분위기 CNT  ( 카페당 분위기유형 중 CNT가 MAX인 대상 )
	WITH RANKMOOD AS (
	  SELECT CAFE_ID AS MOOD_CAFE_ID, MOOD, COUNT(MOOD) AS MOOD_COUNT, MAX(MOD_DATE) AS MOOD_MOD_DATE,
			ROW_NUMBER() OVER (PARTITION BY CAFE_ID ORDER BY COUNT(MOOD) DESC) AS RN
	  FROM MEMBER_ACT
	  WHERE MOOD IS NOT NULL
	  GROUP BY CAFE_ID, MOOD
	)
	SELECT MOOD_CAFE_ID, MOOD, MOOD_COUNT, MOOD_MOD_DATE
	FROM RANKMOOD
	WHERE RN = 1
	ORDER BY MOOD_CAFE_ID
),
A4 AS ( -- 카페별 성별 좋아요 CNT
	SELECT C.CAFE_ID AS GENLIKE_CAFE_ID,    
		   COUNT(CASE WHEN M.GENDER = 'M' THEN 1 END) AS M_LIKE_CNT,
		   COUNT(CASE WHEN M.GENDER = 'F' THEN 1 END) AS F_LIKE_CNT,
		   MAX(MA.MOD_DATE) AS GENLIKE_MOD_DATE    
	FROM MEMBER_ACT MA
	JOIN MEMBER M ON MA.MEMBER_ID = M.MEMBER_ID
	JOIN CAFE C ON MA.CAFE_ID = C.CAFE_ID
	WHERE MA.GOOD = 'Y'
	GROUP BY C.CAFE_ID
),
A5 AS ( -- 카페별 연령대별 좋아요 CNT
	SELECT
		C.CAFE_ID AS AGELIKE_CAFE_ID,    
		COUNT(	CASE
				WHEN FLOOR( ( 	YEAR(CURDATE()) - 
								(CASE 
								WHEN LEFT(M.BIRTHDATE, 2) <= '23' THEN CONCAT('20', LEFT(M.BIRTHDATE, 2))
								ELSE CONCAT('19', LEFT(M.BIRTHDATE, 2))
								END)
							) / 10 ) * 10 = 10 THEN 1 END
			) AS AGE10_LIKE_CNT,        
		COUNT(	CASE         
				WHEN FLOOR( (	YEAR(CURDATE()) - 
								(CASE 
								WHEN LEFT(M.BIRTHDATE, 2) <= '23' THEN CONCAT('20', LEFT(M.BIRTHDATE, 2))
								ELSE CONCAT('19', LEFT(M.BIRTHDATE, 2))
								END)
							) / 10) * 10 = 20 THEN 1 END
			) AS AGE20_LIKE_CNT, 
		COUNT(	CASE         
				WHEN FLOOR( (	YEAR(CURDATE()) - 
								(CASE 
								WHEN LEFT(M.BIRTHDATE, 2) <= '23' THEN CONCAT('20', LEFT(M.BIRTHDATE, 2))
								ELSE CONCAT('19', LEFT(M.BIRTHDATE, 2))
								END)
							) / 10) * 10 = 30 THEN 1 END
			) AS AGE30_LIKE_CNT, 
		COUNT(	CASE         
				WHEN FLOOR(	(	YEAR(CURDATE()) - 
								(CASE 
								WHEN LEFT(M.BIRTHDATE, 2) <= '23' THEN CONCAT('20', LEFT(M.BIRTHDATE, 2))
								ELSE CONCAT('19', LEFT(M.BIRTHDATE, 2))
								END)
							) / 10) * 10 = 40 THEN 1 END
			) AS AGE40_LIKE_CNT, 
		COUNT(	CASE         
				WHEN FLOOR(	(	YEAR(CURDATE()) - 
								(CASE 
								WHEN LEFT(M.BIRTHDATE, 2) <= '23' THEN CONCAT('20', LEFT(M.BIRTHDATE, 2))
								ELSE CONCAT('19', LEFT(M.BIRTHDATE, 2))
								END)
							) / 10) * 10 = 50 THEN 1 END
			) AS AGE50_LIKE_CNT, 
		COUNT(	CASE         
				WHEN FLOOR(	(	YEAR(CURDATE()) - 
								(CASE 
								WHEN LEFT(M.BIRTHDATE, 2) <= '23' THEN CONCAT('20', LEFT(M.BIRTHDATE, 2))
								ELSE CONCAT('19', LEFT(M.BIRTHDATE, 2))
								END)
							) / 10) * 10 >= 60 THEN 1 END
			) AS AGE60_LIKE_CNT,  -- "60대 이상",
		MAX(MA.MOD_DATE) AS AGELIKE_MOD_DATE
	FROM MEMBER_ACT MA
	JOIN MEMBER M ON MA.MEMBER_ID = M.MEMBER_ID
	JOIN CAFE C ON MA.CAFE_ID = C.CAFE_ID
	WHERE MA.GOOD = 'Y'
	GROUP BY C.CAFE_ID
)
SELECT M.CAFE_ID, M.CAFE_NAME, M.SITE, M.CAFE_TYPE, M.ADD_ROAD, M.ADD_OLD, M.DISTANCE, M.METER  
, M.WIFI, M.ANIENTRY, M.PARKING, M.WHEELCHAIR, M.PLAYROOM, M.SMOKINGROOM, M.IMAGE_URL
, A1.LIKE_CNT, A2.REVIEW_CNT, A3.MOOD, A3.MOOD_COUNT, A4.M_LIKE_CNT, A4.F_LIKE_CNT
, A5.AGE10_LIKE_CNT, A5.AGE20_LIKE_CNT, A5.AGE30_LIKE_CNT, A5.AGE40_LIKE_CNT, A5.AGE50_LIKE_CNT, A5.AGE60_LIKE_CNT
, COALESCE( GREATEST(M.MOD_DATE, A1.LIKE_MOD_DATE, A2.REVIEW_MOD_DATE, A3.MOOD_MOD_DATE, A4.GENLIKE_MOD_DATE, A5.AGELIKE_MOD_DATE),
						M.MOD_DATE, A1.LIKE_MOD_DATE, A2.REVIEW_MOD_DATE, A3.MOOD_MOD_DATE, A4.GENLIKE_MOD_DATE, A5.AGELIKE_MOD_DATE) AS LAST_MOD_DATE
FROM CAFE M
LEFT JOIN (A1) ON (M.CAFE_ID = A1.LIKE_CAFE_ID)
LEFT JOIN (A2) ON (M.CAFE_ID = A2.REVIEW_CAFE_ID)
LEFT JOIN (A3) ON (M.CAFE_ID = A3.MOOD_CAFE_ID)
LEFT JOIN (A4) ON (M.CAFE_ID = A4.GENLIKE_CAFE_ID)
LEFT JOIN (A5) ON (M.CAFE_ID = A5.AGELIKE_CAFE_ID)

